GPU的工作原理


#GPU中数据的处理流程

现在让我们来看看第二代GPU是如何完整处理一个画面的吧！首先，来自CPU的各种物理参数进入GPU，Vertex shader将对顶点数据进行基本的判断。如果没有需要处理的Vertex 效果，则顶点数据直接进入T&L Unit 进行传统的T&L操作以节约时间提高效率。如果需要处理各种Vertex 效果，则Vertex shader将先对各种Vertex Programs的指令进行运算，一般的Vertex Programs中往往包含了过去转换、剪切、光照运算等所需要实现的效果，故经由Vertex shader处理的效果一般不需要再进行T&L操作。另外，当遇到涉及到曲面镶嵌(把曲面，比如弓形转换成为多边形或三角形)的场合时。CPU可以直接将数据交给Vertex shader进行处理。

另外，在DireetX的Transform过程中，Vertex shader可以完成Z值的剔除，也就是Back Face Culling――阴面隐去。这就意味粉除了视野以外的顶点，视野内坡前面项点遮住的顶点也会被一并剪除，这大大减轻了需要进行操作的顶点数目。

接下来，经由VertexShader处理完成的各种数据将流入SetupEngine，在这里，运算单元将进行三角形的设置工作，这是整个绘图过程中最重要的一个步骤，Setup Engine甚至直接影响着一块GPU的执行效能。三角形的设置过程是由一个个多边形组成的，或者是用更好的三角形代替原来的三角形。在三维图象中可能会有些三角形被它前面的三角形挡住，但是在这个阶段3D芯片还不知道哪些三角形会被挡住，所以三角形建立单元接收到是一个个由3个顶点组成的完整三角形。三角形的每个角(或顶点)都有对应的X轴、Y轴、Z轴坐标值，这些坐标值确定了它们在3D景物中的位置。同时，三角形的设置也确定了像素填充的范围。，至此，VertexShader的工作就完成了。

过去[第一代]，设置好的三角形本来应该带着各自所有的参数进入像素流水线内进行纹理填充和演染，但现在则不同，在填充之前我们还播要进行PiexlShader的操作。其实，PieXIShader并非独立存在的，它位于纹理填充单元之后，数据流入像紊流水线后先进入纹理填充单元进行纹理填充，然后便是Piex!Shader单元，经由PiexlShader单元进行各种处理运算之后再进入像素填充单元进行具体的粉色，再经由雾化等操作后，一个完整的画面就算完成了。值得注意的是，第二代GPU中普遮引入了独立的显示数据管理机制，它们位于VertexShader、SetuPEngine以及像素流水线之间，负资数据更有效率地传输和组合、各种无效值的剔除、数据的压缩以及寄存器的管理等工作，这个单元的出现对整个GPU工作效率的保证起到了至关重要的作用。

简而言之，GPU的图形（处理）流水线完成如下的工作：（并不一定是按照如下顺序）

#顶点处理：
这阶段GPU读取描述3D图形外观的顶点数据并根据顶点数据确定3D图形的形状及位置关系，建立起3D图形的骨架。在支持DX系列规格的GPU中，这些工作由硬件实现的Vertex Shader（定点着色器）完成。

#光栅化计算：
显示器实际显示的图像是由像素组成的，我们需要将上面生成的图形上的点和线通过一定的算法转换到相应的像素点。把一个矢量图形转换为一系列像素点的过程就称为光栅化。例如，一条数学表示的斜线段，最终被转化成阶梯状的连续像素点。

#纹理帖图：
顶点单元生成的多边形只构成了3D物体的轮廓，而纹理映射（texture mapping）工作完成对多变形表面的帖图，通俗的说，就是将多边形的表面贴上相应的图片，从而生成“真实”的图形。TMU（Texture mapping unit）即是用来完成此项工作。

#像素处理：
这阶段（在对每个像素进行光栅化处理期间）GPU完成对像素的计算和处理，从而确定每个像素的最终属性。在支持DX8和DX9规格的GPU中，这些工作由硬件实现的Pixel Shader（像素着色器）完成。

#最终输出：
由ROP（光栅化引擎）最终完成像素的输出，1帧渲染完毕后，被送到显存帧缓冲区。

总结：GPU的工作通俗的来说就是完成3D图形的生成，将图形映射到相应的像素点上，对每个像素进行计算确定最终颜色并完成输出。


接下来，让我们简单的看一下CPU和GPU之间的数据是如何交互的。
首先从硬盘中读取模型， CPU分类后将多边形信息交给GPU，GPU再时时处理成屏幕上可见的多边形，但是没有纹理只有线框。
模型出来后，GPU将模型数据放进显存，显卡同时也为模型贴材质，给模型上颜色。CPU相应从显存中获取多边形的信息。然后CPU计算光照后产生的影子的轮廓。等CPU计算出后，显卡的工作又有了，那就是为影子中填充深的颜色
这一点要注意的是，无论多牛的显卡，光影都是CPU计算的，GPU只有2个工作，1多边形生成。2为多边形上颜色